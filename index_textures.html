<!DOCTYPE html>
<html style="height: 100%;">
    <body>
        <canvas id="scene" style="height: 100%;"></canvas>
        <script type="importmap">
            {
                "imports": {
                    "three": "/node_modules/three/build/three.module.js",
                    "fflate": "/node_modules/fflate/esm/browser.js",
                    "three/examples/": "/node_modules/three/examples/"
                }
            }
        </script>
        <script type="module" src="js/index.js"></script>
        <script type="module">
            import './js/index.js';

            const nodedefs = await fetch("export/nodedefs.json").then(r => r.json());
            const manifest = await fetch("export/mapblocks/manifest.json").then(r => r.json());

            const wv = new ltwv.WebView({
                target: document.getElementById("scene"),
                wireframe: false,
                source: {
                    mapblock: pos => new Promise(resolve => {
                        const pos_str = `(${pos.x},${pos.y},${pos.z})`;
                        if (manifest.mapblocks[pos_str]) {
                            fetch(`export/mapblocks/${pos_str}.json`)
                            .then(r => r.json())
                            .then(mb => {
                                resolve({
                                    node_mapping: mb.node_mapping,
                                    buffer: ltwv.decompress_base64_gz(mb.mapdata)
                                })
                            });
                        } else {
                            resolve(null);
                        }
                    }),
                    nodedef: nodename => Promise.resolve(nodedefs[nodename]),
                    media: filename => Promise.resolve(`export/media/${filename}`)
                }
            });

            const pos1 = new ltwv.Pos(manifest.min.x, manifest.min.y, manifest.min.z)
            const pos2 = new ltwv.Pos(manifest.max.x, manifest.max.y, manifest.max.z)

            const t1 = Date.now()
            await wv.render(pos1, pos2, (progress, message) => console.log(`Progress: ${Math.floor(progress*100)}%: ${message}`))
            const diff = Date.now() - t1
            console.log("Initial render/generate time: " + diff + " ms")
        </script>
    </body>
</html>